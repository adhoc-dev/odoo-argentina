<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="product_action_server_modify_uom" model="ir.actions.server">
        <field name="name">Cambiar Unidad de Medida del Producto</field>
        <field name="type">ir.actions.server</field>
        <field name="model_id" ref="model_product_template"/>
        <field name="binding_model_id" ref="model_product_template"/>
        <field name="state">code</field>
        <field name="code">
# PARAMETROS
# setear to_uom_id o dejar que se evalue por contexto
to_uom_id = False
# FIN PARAMETROS

if not record.user_has_groups('base.group_system'):
  raise Warning("No esta habilitado para usar esta accion")
record.ensure_one()

to_uom_id = env.context.get('to_uom_id', to_uom_id)

if not to_uom_id:
  raise Warning("No se puede cambiar de Unidad de medida si no define una unidad diferente a la del producto en las UOMS")
def product_uom_change(product_id, new_uom):
    fields = env['ir.model.fields'].search([('ttype', '=', 'many2one'),('relation', '=', 'uom.uom')])
    # raise Warning(fields)
    for field in fields:
        try:
            model = env[field.model].with_context(active_test=False)
        except KeyError:
            continue
        field_name = field.name

        if not model._auto or not model._fields.get(field_name) or not field.store or not model._fields.get('product_id'):
            continue  # Discard SQL views + invalid fields + non-stored fields
        records = model.search([('product_id', 'in', product_id.product_variant_ids.ids)])

        if records:
            # raise Warning(new_uom.name)
            records._write({field_name: new_uom})
            log("Changed %s record(s) in many2one field '%s' of model '%s'" %
                (len(records), field_name, field.model))

record.with_context(odumbo_sync=True).uom_ids.filtered(lambda x : x.uom_id == record.uom_id)._write({'uom_id': to_uom_id})
record.with_context(odumbo_sync=True)._write({'uom_id': to_uom_id,'uom_po_id': to_uom_id})
product_uom_change(record, to_uom_id)
        </field>
    </record>
</odoo>
