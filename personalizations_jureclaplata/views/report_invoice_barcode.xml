<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_invoice_barcode" inherit_id="account.report_invoice_document">

        <t t-set="o" position="after">
            <t t-set="nro_bapro" t-value="str(o.company_id.nro_entidad_bapro).rjust(9, '0')"/>
            <t t-set="reference" t-value="''.join(i for i in o.name if i.isdigit()).rjust(9, '0')[-9:]"/>
            <t t-set="student_code" t-value="str(o.student_id.student_code).rjust(5, '0')"/>
            <t t-set="first_due_date" t-value="o.invoice_date + datetime.timedelta(days=o.company_id.first_due_date_days)"/>
            <t t-set="yy_first_due" t-value="first_due_date.strftime('%y')"/>
            <t t-set="ddd_first_due" t-value="'%03d' % first_due_date.timetuple().tm_yday"/>
            <t t-set="second_due_date" t-value="o.invoice_date + datetime.timedelta(days=o.company_id.second_due_date_days)"/>
            <t t-set="yy_second_due" t-value="second_due_date.strftime('%y')"/>
            <t t-set="ddd_second_due" t-value="'%03d' % second_due_date.timetuple().tm_yday"/>
            <t t-set="close_code" t-value="'01'"/>

            <!-- Deuda del Alumno -->
            <t t-set="debt" t-value="env['account.move'].search([
                    ('company_id', '=', o.company_id.id),
                    ('student_id.student_code', '=', o.student_id.student_code),
                    ('type', '=', 'out_invoice'), ('state', '=', 'posted'),
                    ('invoice_payment_state' , '=', 'not_paid'),
                ], order='date desc')
            "/>

            <t t-set="amount_total" t-value="sum(debt.mapped('amount_residual'))"/>
            <t t-set="str_amount_total" t-value="str(int(amount_total * 100)).rjust(7, '0')"/>

            <!-- Si la factura es de este mes, entonces necesitamos agregar el monto a 2do vencimiento ya que aun no se ha generado nota de debito para el corriente mes-->
            <t t-if="o.invoice_date.month &lt; datetime.date.today().month ">
                <t t-set="surcharge_amount" t-value="0.0"/>
            </t>
            <t t-else="">
                <t t-set="surcharge_amount" t-value="o.amount_residual * (o.company_id.surcharge / 100.0)"/>
            </t>

            <t t-set="str_debit_total" t-value="str(int((amount_total + surcharge_amount) * 100)).rjust(7, '0')"/>

            <!-- Codigo de barras -->
            <t t-set="barcode_payment" t-value="
                nro_bapro + reference + student_code + yy_first_due + ddd_first_due + str_amount_total +
                yy_second_due + ddd_second_due + str_debit_total + close_code
            "/>
        </t>

        <p name="payment_term" position="after">
            <t t-if="o.type == 'out_invoice'">
                <span>Saldo pendiente:</span>
                <t t-if="debt and len(debt) &gt; 1">
                    <table class="table table-sm o_main_table">
                        <thead>
                            <tr>
                                <th><span>Fecha de Factura</span></th>
                                <th><span>Referencia</span></th>
                                <th class="text-right"><span>Importe</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr t-foreach="debt" t-as="invoice">
                                <td><span t-field="invoice.invoice_date"/></td>
                                <td>
                                    <span t-field="invoice.name"/>
                                    <span t-if="invoice.invoice_origin == 'Interests Invoice'"> / Intereses</span>
                                </td>
                                <td class="text-right">
                                    <span t-raw="invoice.amount_residual" t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div t-attf-class="#{'col-6' if report_type != 'html' else 'col-sm-7 col-md-6'} ml-auto">
                        <table class="table table-sm" style="page-break-inside: avoid;">
                            <tr class="border-black o_total">
                                <td><strong>Total</strong></td>
                                <td class="text-right">
                                    <span class="text-nowrap" t-raw="amount_total" t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                </td>
                            </tr>
                        </table>
                    </div>
                </t>
                <t t-else=""><span>No registra.</span></t>

                <br/><div role="separator" class="dropdown-divider"></div><br/>

                <div class="row" style="page-break-inside: avoid;page-break-before: auto;page-break-after:avoid;">
                    <div class="col-12 text-center">
                        <img t-att-src="'/report/barcode/?type=%s&amp;value=%s&amp;humanreadable=1' % ('I2of5', barcode_payment)" alt="Barcode"/>
                    </div>
                </div>
            </t>
        </p>

    </template>

    <template id="report_invoice_document" inherit_id="l10n_ar.report_invoice_document">
        <!-- reescribiomos report_name solo en el caso de facturas de cliente -->
        <t t-set="report_name" position="after">
            <t t-set="report_name" t-if="o.type == 'out_invoice'" t-value="'Boleta de Pago'"/>
            <t t-set="report_name" t-if="o.type == 'out_refund'" t-value="'Credito Boleta de Pago'"/>
        </t>

        <xpath expr="//div[@id='informations']/div/strong" position="replace"/>
        <xpath expr="//div[@id='informations']/div/br" position="replace"/>
        <xpath expr="//div[@id='informations']/div/strong" position="replace"/>
        <xpath expr="//span[@t-field='o.partner_id.l10n_ar_afip_responsibility_type_id']" position="replace"/>

        <t t-if="o.invoice_origin" position="attributes">
            <attribute name="invisible">1</attribute>
        </t>

        <t t-if='o.invoice_date_due' position="attributes">
            <attribute name="t-if">o.invoice_date_due and o.type != 'out_invoice'</attribute>
        </t>
        <t t-if="o.invoice_date_due and o.type != 'out_invoice'" position="after">
            <t t-if="o.type == 'out_invoice'">
                <div class="row">
                    <strong class="col-9">Primer Vencimiento <span t-raw="first_due_date" t-options='{"widget": "date"}'/>:</strong>
                    <span t-field="o.amount_total" class="col-3 text-right"/>
                </div>
                <div class="row">
                    <strong class="col-9">Segundo Vencimiento <span t-raw="second_due_date" t-options='{"widget": "date"}'/>:</strong>
                    <span t-raw="o.amount_total * (1 + o.company_id.surcharge / 100.00)" class="col-3 text-right" t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                </div>
                <strong>Arancel:</strong>
                <span t-if="len(o.invoice_line_ids.mapped('subscription_id')) == 1" t-raw="o.invoice_line_ids.mapped('subscription_id').pricelist_id.name"/>
            </t>
        </t>

        <t t-if="o.ref" position="replace">
            <br/><strong>Alumno/Curso:</strong>
            <t t-if="o.ref" t-raw="o.ref"/>
        </t>
    </template>

    <template id="report_invoice_document_with_payments" inherit_id="l10n_ar.report_invoice_document_with_payments">
        <!-- reescribiomos report_name solo en el caso de facturas de cliente -->
        <t t-set="report_name" position="after">
            <t t-set="report_name" t-if="o.type == 'out_invoice'" t-value="'Boleta de Pago'"/>
            <t t-set="report_name" t-if="o.type == 'out_refund'" t-value="'Credito Boleta de Pago'"/>
        </t>

        <xpath expr="//div[@id='informations']/div/strong" position="replace"/>
        <xpath expr="//div[@id='informations']/div/br" position="replace"/>
        <xpath expr="//div[@id='informations']/div/strong" position="replace"/>
        <xpath expr="//span[@t-field='o.partner_id.l10n_ar_afip_responsibility_type_id']" position="replace"/>

        <t t-if="o.invoice_origin" position="attributes">
            <attribute name="invisible">1</attribute>
        </t>

        <t t-if='o.invoice_date_due' position="attributes">
            <attribute name="t-if">o.invoice_date_due and o.type != 'out_invoice'</attribute>
        </t>
        <t t-if="o.invoice_date_due and o.type != 'out_invoice'" position="after">
            <t t-if="o.type == 'out_invoice'">
                <div class="row">
                    <strong class="col-9">Primer Vencimiento <span t-raw="first_due_date" t-options='{"widget": "date"}'/>:</strong>
                    <span t-field="o.amount_total" class="col-3 text-right"/>
                </div>
                <div class="row">
                    <strong class="col-9">Segundo Vencimiento <span t-raw="second_due_date" t-options='{"widget": "date"}'/>:</strong>
                    <span t-raw="o.amount_total * (1 + o.company_id.surcharge / 100.00)" class="col-3 text-right" t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                </div>
                <strong>Arancel:</strong>
                <span t-if="len(o.invoice_line_ids.mapped('subscription_id')) == 1" t-raw="o.invoice_line_ids.mapped('subscription_id').pricelist_id.name"/>
            </t>
        </t>

        <t t-if="o.ref" position="replace">
            <br/><strong>Alumno/Curso:</strong>
            <t t-if="o.ref" t-raw="o.ref"/>
        </t>
    </template>

    <template id="personalization_header_report" inherit_id="l10n_ar.custom_header">
        <t t-if="not pre_printed_report" position="replace">
            <t t-raw="o.company_id.header_left"/>
        </t>
        <xpath expr="//t[@t-if='not pre_printed_report'][last()]" position="replace">
            <t t-raw="o.company_id.header_right"/>
        </xpath>
    </template>
</odoo>
