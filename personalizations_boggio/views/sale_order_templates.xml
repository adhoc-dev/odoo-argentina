<?xml version='1.0' encoding='UTF-8'?>
<odoo>
  <template id="boggio_sales" inherit_id="l10n_ar_sale.report_saleorder_document">

    <xpath expr="//span[@t-field='doc.partner_id.commercial_partner_id.name']//../strong" position="replace">
      <span>Cliente: </span>
    </xpath>
    <xpath expr="//span[@t-field='doc.user_id']//../strong" position="replace">
      <span>Comercial: </span>
    </xpath>
    <xpath expr="//span[@t-field='doc.validity_date']//../strong" position="replace">
      <span>Vencimiento: </span>
    </xpath>
    <xpath expr="//span[@t-field='doc.payment_term_id.name']//../strong" position="replace">
      <span>Términos de Pago: </span>
    </xpath>
    <xpath expr="//span[@t-field='doc.client_order_ref']//../strong" position="replace">
      <span>Referencia de Cliente: </span>
    </xpath>
    <xpath expr="//span[@t-field='doc.partner_id.l10n_ar_afip_responsibility_type_id']//../strong[1]" position="replace">
      <span>Cond. IVA: </span>
    </xpath>
    <xpath expr="//t[@t-esc='doc.partner_id.l10n_latam_identification_type_id.name or doc.company_id.country_id.vat_label']//..//..//strong" position="replace">
      <t t-esc="doc.partner_id.l10n_latam_identification_type_id.name or doc.company_id.country_id.vat_label" id="inv_tax_id_label" />:
    </xpath>
    <span t-field="doc.partner_id.commercial_partner_id.name" position="replace">
      <strong>
        <t>$0</t>
      </strong>
    </span>
    <span t-field="doc.validity_date" position="replace">
      <strong>
        <t>$0</t>
      </strong>
    </span>
    <span t-field="doc.user_id" position="replace">
      <strong>
        <t>$0</t>
      </strong>
    </span>
    <span t-field="doc.payment_term_id.name" position="replace">
      <strong>
        <t>$0</t>
      </strong>
    </span>
    <span t-field="doc.client_order_ref" position="replace">
      <strong>
        <t>$0</t>
      </strong>
    </span>

    <span t-field="doc.partner_id.l10n_ar_afip_responsibility_type_id" position="replace">
      <strong>
        <t>$0</t>
      </strong>
    </span>
    <span t-esc="doc.partner_id.l10n_ar_formatted_vat or doc.partner_id.vat" position="replace">
      <strong>
        <t>$0</t>
      </strong>
    </span>
    <span t-field="doc.partner_id" position="after">
      <strong t-if="doc.partner_id.commercial_partner_id != doc.partner_id">Conctato: </strong>
      <span t-if="doc.partner_id.commercial_partner_id != doc.partner_id" t-field="doc.partner_id.name" />
      <br t-if="doc.partner_id.commercial_partner_id != doc.partner_id" />
    </span>
    <span t-field="doc.partner_id.commercial_partner_id.name" position="before">
      <span t-if="doc.partner_id.commercial_partner_id.internal_code" t-esc="'[%s]' % (doc.partner_id.commercial_partner_id.internal_code)" />
    </span>
    <xpath expr="//th[@name='th_image']" position="before">
      <th name="th_number_order_line_order_line" class="text-left">N°</th>
    </xpath>
    <xpath expr="//th[@name='th_quantity']" position="before">
      <th name="th_brand_order_line_order_line" class="text-left">Marca</th>
    </xpath>
    <xpath expr="//td[@name='td_image']" position="before">
      <td name="td_number_order_line">
        <span t-field="line.number" />
      </td>
    </xpath>
    <td name="td_quantity" position="before">
      <td name="td_brand_order_line">
        <span t-field="line.product_brand_id" />
      </td>
    </td>
    <span t-field="line.product_uom_qty" position="before">

      <span t-esc="line.product_id.with_context(warehouse=line.warehouse_id.id).free_qty-line.product_uom_qty &gt;= 0 and ' ' or '(*)'" />


    </span>

    <td name="td_priceunit" position="replace">
      <td name="td_priceunit" class="text-right">
        <span t-options='{"widget": "float", "precision": 2}' t-esc="line.report_price_unit * (1-line.discount1/100.0)" />
      </td>

    </td>
    <td t-if="display_discount" position="replace">
      <td t-if="display_discount" class="text-right" groups="product.group_discount_per_so_line">
        <span t-esc="' %s %s' % (line.discount2 or '', line.discount3 or '')" />
      </td>

    </td>

    <p t-field="doc.note" position="before">
      <p t-if="doc.commitment_date">
        <strong>Fecha de Entrega:</strong>
        <span t-field="doc.commitment_date" t-options="{&quot;widget&quot;: &quot;date&quot;}" />
      </p>
      <p>
        Los precios e importes de los artículos están expresados en
        <span t-field="doc.currency_id" />
        <span t-if="doc.currency_id.id !=20" t-esc="' ('+ str(doc.currency_id.inverse_rate) + datetime.datetime.today().strftime(' al %d/%m/%Y') +')'" />
        .
        <br />
        Las garantias son de 1 año a menos que se indique otra duración en el producto.
      </p>
    </p>

    <p id="fiscal_position_remark" position="after">

      <!-- html variable que configuran en la plantilla de presupuesto -->
      <t t-raw="doc.sale_order_template_id.pdf_footer" />

      <div class="row">
        <div class="col-3"/>
        <div class="col-8 text-right">
          <t t-set="uid_create" t-value="doc.create_uid.id != 1 and doc.create_uid or doc.user_id"/>
          <span t-esc="'Ud. fue atendido por %s - %s - %s' % (uid_create.name, uid_create.email, uid_create.function)"/>
        </div>
        <div class="col-1 text-left">
          <img t-if="uid_create.image_256" t-att-src="image_data_uri(uid_create.image_256)" style="max-height: 60px;" alt="Logo"/>
        </div>
      </div>
    </p>

    <!-- al subtotal de las lineas le sacamos el simbolo de la moneda -->
    <xpath expr="//span[@t-field='line.report_price_subtotal'][1]" position="attributes">
      <attribute name="t-options">{'widget': 'float', 'precision': currency_precision}</attribute>
    </xpath>
    <xpath expr="//span[@t-field='line.report_price_subtotal'][2]" position="attributes">
      <attribute name="t-options">{'widget': 'float', 'precision': currency_precision}</attribute>
    </xpath>

    <span t-field="line.product_id.image_256" position="replace">
      <a target="_blank" t-att-href="'https://www.ingenieriaboggio.com.ar/shop/product/%i' % (line.product_id.product_tmpl_id.id)">
        <t>$0</t>
      </a>
    </span>


    <span t-field="line.name" position="replace">
      <span t-esc="'%s %s (%s) %s' % (line.product_id.internal_code[1:] ,line.name.replace('[' + line.product_id.internal_code +']', ''), line.product_id.supplier_code or '', line.product_id.warranty!=12 and line.product_id.warranty or ' ')" />
      <a t-if="line.product_id.x_website_catalog" target="_blank" t-attf-href="line.product_id.x_website_catalog" class="fa fa-link" role="img" />
      <a t-if="line.product_id.x_documents" target="_blank" t-attf-href="'https://www.ingenieriaboggio.com.ar' + line.product_id.x_documents.url_suffix" class="fa fa-book" role="img" />
    </span>
    <span t-field="doc.report_amount_untaxed" position="replace">
      <strong>
        <t>$0</t>
      </strong>
    </span>
    <span t-field="doc.amount_total" position="replace">
      <strong>
        <t>$0</t>
      </strong>
    </span>

    <xpath expr="//td[@name='td_option_price_unit']//strong" position="replace" />
    <th name="th_option_price_unit" position="replace" />
    <table name="table_optional_products" position="attributes">
      <attribute name="style">font-size: 0.8em;</attribute>
    </table>


  </template>

  <template id="boggio_sales_control">
    <t t-name="sale.boggio_sales_control">
      <t t-call="web.html_container">
        <t t-foreach="docs" t-as="doc">
          <t t-call="personalizations_boggio.boggio_sales_control_view" t-lang="doc.partner_id.lang" />
        </t>
      </t>
    </t>

  </template>

  <template id="boggio_sales_control_view" primary="True" priority="99" inherit_id="boggio_sales">
    <div id="informations" position="replace">
      <div id="control" class="row mt8 mb8">
        <div class="col-6">
          <span t-esc="' %s (%s) %s' % (doc.commercial_partner_id.abc_sales_amount, doc.commercial_partner_id.internal_code, doc.commercial_partner_id.name)" />
          <br />
          <strong>Comercial: </strong>
          <span t-field="doc.commercial_partner_id.user_id" />
          <br />
          <strong>Cond. de Venta del cliente:: </strong>
          <span t-esc="doc.commercial_partner_id.property_payment_term_id[0].name" />
          <br />
          <strong>Lista de precios del cliente: </strong>
          <span t-esc="doc.commercial_partner_id.property_product_pricelist[0].name" />

          <!-- <span t-esc="'\n'.join(doc.env['product.pricelist'].search([['currency_id', '=', 1],['active', '=', 'True']]).mapped(lambda x : x.x_venta_min &gt;= sum(doc.env['account.move'].search( [['partner_id', '=', doc.commercial_partner_id.id],['invoice_payment_state', '=', 'paid'], ['type', 'in', ['out_invoice','in_invoice','out_refund', 'in_refund']],['invoice_date', '&gt;=', datetime.datetime.today() - datetime.timedelta(120)],['invoice_date', '&lt;=', datetime.datetime.today()]]).mapped(lambda line: line.amount_total_signed ))/4 and sum(doc.env['account.move'].search( [['partner_id', '=', doc.commercial_partner_id.id],['invoice_payment_state', '=', 'paid'], ['type', 'in', ['out_invoice','in_invoice','out_refund', 'in_refund']],['invoice_date', '&gt;=', datetime.datetime.today() - datetime.timedelta(120)],['invoice_date', '&lt;=', datetime.datetime.today()]]).mapped(lambda line: line.amount_total_signed ))/4 &lt;= x.x_venta_max or ' '))" /> -->

        </div>
      </div>
      <div class="col-8">

        <table class="table table-sm o_main_table" name="table">
          <thead>
            <tr>
              <th>
                <span>venta promedio de cada operación del cuatrimestre *</span>
              </th>
              <th>
                <span>Promedio de venta del cuatrimestre</span>
              </th>
              <th>
                <span>Promedio de cobro del cuatrimestre *</span>
              </th>
              <th>
                <span>Deuda sin indexar</span>
              </th>
              <th>
                <span>Limite de credito</span>
              </th>
              <th>
                <span>Limite de credito estimado (a revisar por encargado)</span>
              </th>
              <th>
                <span>Dias en la calle</span>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-right">
                <span t-options='{"widget": "float", "precision": 2}' t-if="len(doc.env['account.move'].search( [['partner_id', '=', doc.commercial_partner_id.id],['invoice_payment_state', '=', 'paid'], ['type', 'in', ['out_invoice','in_invoice','out_refund', 'in_refund']],['invoice_date', '&gt;=', datetime.datetime.today() - datetime.timedelta(120)],['invoice_date', '&lt;=', datetime.datetime.today()]])) &gt; 0" t-esc="sum(doc.env['account.move'].search( [['partner_id', '=', doc.commercial_partner_id.id],['invoice_payment_state', '=', 'paid'], ['type', 'in', ['out_invoice','in_invoice','out_refund', 'in_refund']],['invoice_date', '&gt;=', datetime.datetime.today() - datetime.timedelta(120)],['invoice_date', '&lt;=', datetime.datetime.today()]]).mapped(lambda line: line.amount_total_signed))/len(doc.env['account.move'].search( [['partner_id', '=', doc.commercial_partner_id.id],['invoice_payment_state', '=', 'paid'], ['type', 'in', ['out_invoice','in_invoice','out_refund', 'in_refund']],['invoice_date', '&gt;=', datetime.datetime.today() - datetime.timedelta(120)],['invoice_date', '&lt;=', datetime.datetime.today()]]))" />
              </td>
              <td class="text-right">
                <span class="text-nowrap" t-options='{"widget": "float", "precision": 2}' t-esc="sum(doc.env['account.move'].search( [['partner_id', '=', doc.commercial_partner_id.id],['invoice_payment_state', '=', 'paid'], ['type', 'in', ['out_invoice','in_invoice','out_refund', 'in_refund']],['invoice_date', '&gt;=', time.strftime('%Y-%m-%d', time.gmtime(time.time( )-120*24*60*60))],['invoice_date', '&lt;=', time.strftime('%Y-%m-%d', time.gmtime( ))]]).mapped(lambda line: line.amount_total_signed ))/4" />
              </td>
              <td class="text-right">
                <span class="text-nowrap" t-options='{"widget": "float", "precision": 2}' t-esc="sum(doc.env['account.payment.group'].search( [['partner_id', '=', doc.commercial_partner_id.id],['state', '!=', 'draft'],['payment_date', '&gt;=', time.strftime('%Y-%m-%d', time.gmtime(time.time( )-120*24*60*60))],['payment_date', '&lt;=', time.strftime('%Y-%m-%d', time.gmtime( ) )]]).mapped(lambda line: line.payments_amount))/4" />
              </td>
              <td class="text-right">
                <span class="text-nowrap" t-esc="doc.commercial_partner_id.credit" />
              </td>
              <td class="text-right">
                <span class="text-nowrap" t-esc="doc.commercial_partner_id.credit_limit" />
              </td>
              <td class="text-right">
                <span class="text-nowrap" t-esc="int(sum(doc.env['account.payment.group'].search( [['partner_id', '=', doc.commercial_partner_id.id],['state', '!=', 'draft'],['payment_date', '&gt;=', time.strftime('%Y-%m-%d', time.gmtime(time.time( )-120*24*60*60))],['payment_date', '&lt;=', time.strftime('%Y-%m-%d', time.gmtime())]]).mapped(lambda line: line.payments_amount))/4*1.25/1000)*1000" />
              </td>
              <td class="text-right">
                <span class="text-nowrap" t-esc="int(sum(doc.env['account.move.line'].search( [['partner_id', '=', doc.commercial_partner_id.id], ['account_id.internal_type', '=', 'receivable'],['full_reconcile_id', '=', False], ['account_id.reconcile', '=', True]]).mapped(lambda line: line.financial_amount_residual))/((sum(doc.env['account.payment.group'].search( [['partner_id', '=', doc.commercial_partner_id.id],['state', '!=', 'draft'],['payment_date', '&gt;=', time.strftime('%Y-%m-%d', time.gmtime(time.time( )-120*24*60*60))],['payment_date', '&lt;=', time.strftime('%Y-%m-%d', time.gmtime())]]).mapped(lambda line: line.payments_amount))+1.0)/4)*30 )" />
              </td>
            </tr>
          </tbody>
        </table>
        <br />
        <strong>Cond. de Venta del comprobante: </strong>
        <span t-esc="doc.payment_term_id.name" />
        <br />
        <strong>Lista de precios del cliente: </strong>
        <span t-esc="doc.pricelist_id.name" />
      </div>

    </div>
    <table class="table table-sm" position="before">
      <br />
      <span class="text-right" t-options='{"widget": "float", "precision": 2}' t-esc="((doc.amount_untaxed/sum(doc.order_line.mapped(lambda line: line.purchase_price *line.product_uom_qty )))-1)*100" /><span>%</span>
    </table>
    <span t-esc="line.report_price_unit * (1-line.discount1/100.0)" position="after">
      <br />
      <span t-options='{"widget": "float", "precision": 2}' t-esc="line.purchase_price and ((line.report_price_unit * (1-line.discount1/100.0) * (1-line.discount2/100.0)*(1-line.discount3/100.0)/line.purchase_price)-1)*100 or 0.0" /><span>%</span>
    </span>
    <span t-esc="'%s %s (%s) %s' % (line.product_id.internal_code[1:] ,line.name.replace('[' + line.product_id.internal_code +']', ''), line.product_id.supplier_code or '', line.product_id.warranty!=12 and line.product_id.warranty or ' ')" position="attributes">
      <attribute name="t-esc">'%s (%s) %s %s %s %s (%s)  %s / UT: %s' % (line.product_id.name, line.product_id.supplier_code and line.product_id.supplier_code or '', line.name and line.name.startswith('--') and line.name[3:] or '',line.product_id.seller_ids[0].name.x_lista_proveedor, line.product_id.seller_ids[0].name.x_desc_pago_prov,line.product_id.replenishment_cost_rule_id.name, line.product_id.replenishment_cost_last_update, line.product_id.replenishment_cost_rule_id.item_ids.mapped('percentage_amount'),line.product_id.sale_margin)</attribute>
    </span>
    <a t-if="line.product_id.x_website_catalog" position="replace" />
    <a t-if="line.product_id.x_documents" position="replace" />
  </template>
</odoo>
